Bootstrap: docker
From: ubuntu:24.04

%labels
    Author Ziyue Cheng
    Version 1.0
    Description "CondaTainer Ubuntu24 base image"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PS1='CNT \w> '

%runscript
    exec /bin/bash "$@"

%post
    # Avoid interactive prompts
    export DEBIAN_FRONTEND=noninteractive

    # fakeroot squashfuse fuse2fs gocryptfs: nested mounting
    # python3-requests python3-bs4: for some helper scripts
    # tzdata: timezone data
    # time: for measuring time/cpu/memory usage
    apt-get update && apt-get install -y \
        squashfs-tools fuse \
        sudo ca-certificates \
        curl wget aria2 git \
        bash zsh fish tree \
        tar pigz unzip bzip2 xz-utils zstd lz4 \
        python3-requests python3-bs4 python-is-python3 \
        tzdata time jq tmux bash-completion

    # Internal Apptainer (add nested mounting support)
    apt-get install -y \
        build-essential libseccomp-dev uidmap \
        fakeroot squashfuse fuse2fs gocryptfs \
        cryptsetup tzdata dh-apparmor libsubid-dev
    wget -qO apptainer.deb https://github.com/apptainer/apptainer/releases/download/v1.4.5/apptainer_1.4.5_amd64.deb
    dpkg -i apptainer.deb && rm -f apptainer.deb

    apt-get clean && rm -rf /var/lib/apt/lists/*

    # Download Micromamba to /usr/bin
    ARCH="$(uname -m)"
    case "$ARCH" in
        aarch64|ppc64le|arm64) ;;  # pass
        *) ARCH="64" ;;
    esac
    RELEASE_URL="https://github.com/mamba-org/micromamba-releases/releases/latest/download/micromamba-linux-${ARCH}"
    wget -qO /usr/bin/micromamba "${RELEASE_URL}"
    chmod +x /usr/bin/micromamba

    # Add helper scripts for create/install/update/remove $CNT_CONDA_PREFIX will be set to the .img overlay path
    cat << 'EOT' > /usr/bin/mm-create
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi

yaml_file=""
args=("$@")
for ((i=0; i<${#args[@]}; i++)); do
    if [[ "${args[i]}" == "-f" ]] || [[ "${args[i]}" == "--file" ]]; then
        yaml_file="${args[i+1]}"
        break
    fi
done

if [[ -n "$yaml_file" && -f "$yaml_file" ]]; then
    echo "Detected Environment File: $yaml_file"
    /usr/bin/micromamba -r "$CNT_CONDA_PREFIX" create -n base "$@"
    # Extract 'channels' to .condarc
    awk '/^channels:/ {flag=1; print; next} /^[a-zA-Z0-9]/ {flag=0} flag {print}' "$yaml_file" > "$CNT_CONDA_PREFIX/.condarc"
else
    /usr/bin/micromamba -r "$CNT_CONDA_PREFIX" create -c conda-forge -c bioconda -n base "$@"
    cat << EOF > "$CNT_CONDA_PREFIX/.condarc"
channels:
  - conda-forge
  - bioconda
EOF
fi
EOT
    chmod +x /usr/bin/mm-create

    cat << 'EOT' > /usr/bin/mm-install
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX install -c conda-forge -c bioconda "$@"
EOT
    chmod +x /usr/bin/mm-install

    cat << 'EOT' > /usr/bin/mm-update
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX update -c conda-forge -c bioconda "$@"
EOT
    chmod +x /usr/bin/mm-update

    cat << 'EOT' > /usr/bin/mm-remove
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX remove "$@"
EOT
    chmod +x /usr/bin/mm-remove

    cat << 'EOT' > /usr/bin/mm-list
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX list "$@"
EOT
    chmod +x /usr/bin/mm-list

    cat << 'EOT' > /usr/bin/mm-export
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX env export "$@"
EOT
    chmod +x /usr/bin/mm-export

    cat << 'EOT' > /usr/bin/mm-search
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX search -c conda-forge -c bioconda "$@"
EOT
    chmod +x /usr/bin/mm-search

    cat << 'EOT' > /usr/bin/mm-clean
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX clean "$@"
EOT
    chmod +x /usr/bin/mm-clean

cat << 'EOT' > /usr/bin/mm-pin
#!/bin/bash

if [ -z "$CNT_CONDA_PREFIX" ]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi

PIN_FILE="$CNT_CONDA_PREFIX/conda-meta/pinned"
mkdir -p "$(dirname "$PIN_FILE")"
touch "$PIN_FILE"

# Function to show usage
show_usage() {
    echo "Usage: mm-pin [options] <package>"
    echo ""
    echo "Options:"
    echo "  <package>           Pin a package (current version). e.g., 'numpy'"
    echo "  <package>=<ver>     Pin a specific version. e.g., 'numpy=1.21'"
    echo "  -u, -d, -r          Unpin/Delete/Remove a package."
    echo "  -l, --list          List all pinned packages."
    echo "  -h, --help          Show this help message."
    exit 1
}

list_pins() {
    if [ -s "$PIN_FILE" ]; then
        echo "Currently pinned packages:"
        echo "---------------------------"
        cat "$PIN_FILE"
        echo "---------------------------"
    else
        echo "No packages are currently pinned."
    fi
}

unpin_package() {
    local PACKAGE_NAME=$1
    if [ -z "$PACKAGE_NAME" ]; then
        echo "Error: Please specify a package to unpin."
        exit 1
    fi

    if grep -qE "^${PACKAGE_NAME} " "$PIN_FILE"; then
        sed -i "/^${PACKAGE_NAME} /d" "$PIN_FILE"
        echo "Unpinned package: $PACKAGE_NAME"
    else
        echo "Package '$PACKAGE_NAME' is not currently pinned."
    fi
}

pin_package() {
    local PACKAGE_INPUT=$1

    if [[ "$PACKAGE_INPUT" == *"="* ]]; then
        # Case: package=version provided
        PACKAGE_NAME=$(echo "$PACKAGE_INPUT" | cut -d'=' -f1)
        PIN_VALUE=$(echo "$PACKAGE_INPUT" | sed 's/=/ /')
    else
        # Case: package only (lookup installed version)
        PACKAGE_NAME=$PACKAGE_INPUT
        echo "Searching for installed version of '$PACKAGE_NAME'..."

        INSTALLED_VER=$(mm-list "^${PACKAGE_NAME}$" | grep "${PACKAGE_NAME} " | awk '{print $1 " " $2}')

        if [ -z "$INSTALLED_VER" ]; then
            echo "Error: Package '$PACKAGE_NAME' not found in the current environment."
            exit 1
        fi
        PIN_VALUE="$INSTALLED_VER"
    fi

    if grep -qE "^${PACKAGE_NAME} " "$PIN_FILE"; then
        echo "Updating existing pin for package '$PACKAGE_NAME'."
        sed -i "/^${PACKAGE_NAME} /d" "$PIN_FILE"
    fi

    echo "$PIN_VALUE" >> "$PIN_FILE"
    echo "Pinned: $PIN_VALUE"
}

case "$1" in
    -l|--list)
        list_pins
        ;;
    -u|--unpin|-r|--remove|-d|--delete)
        shift
        unpin_package "$1"
        ;;
    -h|--help)
        show_usage
        ;;
    -*)
        echo "Error: Unknown option '$1'"
        show_usage
        ;;
    "")
        show_usage
        ;;
    *)
        pin_package "$1"
        ;;
esac
EOT
    chmod +x /usr/bin/mm-pin
