# For CPU only
#     ubuntu:24.04
# For GPU support, change base image to
#     nvidia/cuda:13.0.2-cudnn-devel-ubuntu24.04
#     rocm/dev-ubuntu-24.04:latest

Bootstrap: docker
From: nvidia/cuda:13.0.2-cudnn-devel-ubuntu24.04

%labels
    Author Ziyue Cheng
    Version 1.0
    Description "Ubuntu24-based container with squashfs-tools, micromamba and NV GPU support"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PS1='CNT \w> '

%post
    # Avoid interactive prompts
    export DEBIAN_FRONTEND=noninteractive

    # fakeroot squashfuse fuse2fs gocryptfs: nested mounting
    # python3-requests python3-bs4: for some helper scripts
    # tzdata: timezone data
    # time: for measuring time/cpu/memory usage
    apt-get update && apt-get install -y \
        squashfs-tools fuse \
        sudo ca-certificates \
        curl wget aria2 git \
        tar pigz unzip bzip2 xz-utils zstd lz4 \
        fakeroot squashfuse fuse2fs gocryptfs \
        python3-requests python3-bs4 \
        tzdata time jq tmux \
        && apt-get clean \
        && rm -rf /var/lib/apt/lists/*

    # Download Micromamba to /usr/bin
    ARCH="$(uname -m)"
    case "$ARCH" in
        aarch64|ppc64le|arm64) ;;  # pass
        *) ARCH="64" ;;
    esac
    RELEASE_URL="https://github.com/mamba-org/micromamba-releases/releases/latest/download/micromamba-linux-${ARCH}"
    wget -qO /usr/bin/micromamba "${RELEASE_URL}"
    chmod +x /usr/bin/micromamba

    # Add helper scripts for create/install/update/remove $CNT_CONDA_PREFIX will be set to the .img overlay path
    cat << 'EOT' > /usr/bin/mm-create
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX create -c conda-forge -c bioconda -p $CNT_CONDA_PREFIX "$@"
cat << EOF > "$CNT_CONDA_PREFIX/.condarc"
channels:
  - conda-forge
  - bioconda
channel_priority: strict
EOF
EOT
    chmod +x /usr/bin/mm-create

    cat << 'EOT' > /usr/bin/mm-install
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX install -c conda-forge -c bioconda -p $CNT_CONDA_PREFIX "$@"
EOT
    chmod +x /usr/bin/mm-install

    cat << 'EOT' > /usr/bin/mm-update
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX update -c conda-forge -c bioconda -p $CNT_CONDA_PREFIX "$@"
EOT
    chmod +x /usr/bin/mm-update

    cat << 'EOT' > /usr/bin/mm-remove
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX remove -p $CNT_CONDA_PREFIX "$@"
EOT
    chmod +x /usr/bin/mm-remove

    cat << 'EOT' > /usr/bin/mm-list
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX list -p $CNT_CONDA_PREFIX "$@"
EOT
    chmod +x /usr/bin/mm-list

    cat << 'EOT' > /usr/bin/mm-export
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX env export -p $CNT_CONDA_PREFIX "$@"
EOT
    chmod +x /usr/bin/mm-export

    cat << 'EOT' > /usr/bin/mm-search
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX search -c conda-forge -c bioconda "$@"
EOT
    chmod +x /usr/bin/mm-search

    cat << 'EOT' > /usr/bin/mm-clean
#!/usr/bin/bash
if [[ -z "$CNT_CONDA_PREFIX" ]]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi
/usr/bin/micromamba -r $CNT_CONDA_PREFIX clean "$@"
EOT
    chmod +x /usr/bin/mm-clean

    cat << 'EOT' > /usr/bin/mm-pin
#!/bin/bash

if [ -z "$CNT_CONDA_PREFIX" ]; then
    echo "ERROR: CNT_CONDA_PREFIX is not set!"
    exit 1
fi

PACKAGE_INPUT=$1

# Check if input is empty
if [ -z "$PACKAGE_INPUT" ]; then
    echo "Usage: mm-pin <package> or mm-pin <package>=<version>"
    exit 1
fi

PIN_FILE="$CNT_CONDA_PREFIX/conda-meta/pinned"
mkdir -p "$(dirname "$PIN_FILE")"
if ! [ -f "$PIN_FILE" ]; then
    touch "$PIN_FILE"
fi

if [[ "$PACKAGE_INPUT" == *"="* ]]; then
    # If input contains '=', treat it as package=version
    PACKAGE_NAME=$(echo "$PACKAGE_INPUT" | cut -d'=' -f1)
    PIN_VALUE=$(echo "$PACKAGE_INPUT" | sed 's/=/ /')

    if grep -qE "^${PACKAGE_NAME} " "$PIN_FILE"; then
        echo "Updating existing pin for package '$PACKAGE_NAME'."
        sed -i "/^${PACKAGE_NAME} /d" "$PIN_FILE"
    fi

    echo "$PIN_VALUE" >> "$PIN_FILE"
    echo "Pinned: $PIN_VALUE"
else
    # Otherwise, search for the installed version
    echo "Searching for installed version of '$PACKAGE_INPUT'..."
    
    INSTALLED_VER=$(mm-list "^${PACKAGE_INPUT}$" | grep "${PACKAGE_INPUT} " | awk '{print $1 " " $2}')

    if [ -z "$INSTALLED_VER" ]; then
        echo "Error: Package '$PACKAGE_INPUT' not found in the current environment"
        exit 1
    fi

    if grep -qE "^${PACKAGE_INPUT} " "$PIN_FILE"; then
        echo "Updating existing pin for package '$PACKAGE_INPUT'"
        sed -i "/^${PACKAGE_INPUT} /d" "$PIN_FILE"
    fi

    echo "$INSTALLED_VER" >> "$PIN_FILE"
    echo "Pinned: $INSTALLED_VER"
fi
EOT
    chmod +x /usr/bin/mm-pin

%runscript
    echo "This container provides mksquashfs and micromamba inside Ubuntu24 with NV GPU support"
    exec /bin/bash "$@"

%help
    This container provides:
      - mksquashfs
      - fuse
    You can use it to convert ext3 overlay images to SquashFS inside Apptainer
