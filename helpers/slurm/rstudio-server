#!/bin/bash
# This script helps run rstudio-server with r image on SLURM clusters.

# Use Posit r-base docker image https://hub.docker.com/r/posit/r-base
AVAIL_R_VERSIONS='
    4.0.0 4.0.1 4.0.2 4.0.3 4.0.4 4.0.5
    4.1.0 4.1.1 4.1.2 4.1.3
    4.2.0 4.2.1 4.2.2 4.2.3
    4.3.0 4.3.1 4.3.2 4.3.3
    4.4.0 4.4.1 4.4.2 4.4.3
    4.5.0 4.5.1 4.5.2
'
BASE_IMAGE_DISTRO="noble"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
source "$SCRIPT_DIR/.common.sh"
HELPER_NAME=rstudio-server

# Save defaults on first run
config_init $HELPER_NAME \
    NCPUS=4 \
    MEM=32G \
    TIME=12:00:00 \
    GPU= \
    BASE_IMAGE= \
    BASE_IMAGE_DISTRO=noble \
    PORT= \
    AUTH=none \
    R_VERSION= \
    OVERLAY=env.img

# Load saved defaults
config_load $HELPER_NAME
config_require $HELPER_NAME NCPUS MEM TIME OVERLAY

print_help() {
    echo "Usage: $0 [options]"
    echo ""
    echo "Options:"
    echo "  -r <r_version>  R version to use (e.g., 4.4.3)"
    echo "  -c <number>     Number of CPUs to allocate (default: $NCPUS)"
    echo "  -m <memory>     Amount of memory to allocate (default: $MEM)"
    echo "  -t <time>       Time limit for the job (default: $TIME)"
    echo "  -g <gpu>        GPU resources (e.g., 1, a100:2). Empty means no GPU."
    echo "  -v              View Mode NCPUS:1 MEM:8G TIME:02:00:00"
    echo ""
    echo "  -p <port>       Port for $HELPER_NAME (default: ${PORT:-randomly picked}). Valid range: 1024-65535."
    echo "  -e <overlay>    Environment overlay image file (default: $OVERLAY)"
    echo "  -o <overlay>    Additional overlay files (can have multiple -o options)"
    echo ""
    echo "  config           Show config file path and contents"
    echo ""
    echo "Config file: $(config_path $HELPER_NAME)"
    echo "Delete this file to reset to defaults."
}

case $1 in
    config)         config_show $HELPER_NAME ;;
    --help|-h|help) print_help; exit 0 ;;
    *)              ;;
esac

# show_and_connect <job_id>
#   Prints connection info and opens SSH tunnel with port forwarding.
show_and_connect() {
    local job_id="$1"
    print_info "$HELPER_NAME at ${BLUE}http://localhost:$PORT${NC}"
    print_info "You can run the following command in R to open the project directly:"
    print_info "  ${YELLOW}rstudioapi::openProject(\"$CWD\")${NC}"
    print_info "If you want to stop it, run: ${YELLOW}scancel $job_id${NC}"
    exec ssh ${SSH_OPTS} -o ControlMaster=no -L "$PORT:localhost:$PORT" "$USER@$NODE"
    exit 0
}

print_specs() {
    print_msg "  CPUs: ${BLUE}$NCPUS${NC} MEM: ${BLUE}$MEM${NC} TIME: ${BLUE}$TIME${NC}"
    [ -n "$GPU" ] && print_msg "  GPU: ${BLUE}$GPU${NC}"
    print_msg "  Port: ${BLUE}$PORT${NC}"
    print_msg "  R Version: ${BLUE}$R_VERSION${NC}"
    print_msg "  Working Dir: ${BLUE}$CWD${NC}"
    print_msg "  Overlay: ${BLUE}$OVERLAY${NC}"
    [ -n "$OVERLAYS" ] && print_msg "  Additional overlays: ${BLUE}$OVERLAYS${NC}"
}

STATE_FILE="$HELPER_STATE_DIR/$HELPER_NAME"
read_job_state "$STATE_FILE"
case $? in
    1) # PENDING
        print_info "Found a pending $HELPER_NAME job (ID: ${YELLOW}$JOB_ID${NC})."
        wait_for_job "$JOB_ID"
        show_and_connect "$JOB_ID"
        ;;
    2) # RUNNING
        print_info "Found an existing $HELPER_NAME job (ID: ${YELLOW}$JOB_ID${NC}) running on node ${BLUE}$NODE${NC}."
        show_and_connect "$JOB_ID"
        ;;
    3) # Not running - ask about reusing previous overlay settings
        print_info "The previous $HELPER_NAME job (ID: ${YELLOW}$JOB_ID${NC}) is no longer running."
        if [ -n "$OVERLAY" ]; then
            print_msg "Previous run used:"
            print_specs
            if confirm_default_yes "Reuse these settings and go to the previous working directory?"; then
                cd "$CWD"
            else
                PRE_PORT="$PORT"
                config_load $HELPER_NAME silent
                OVERLAYS="" # Reset overlays since we are loading fresh config
                if [ -z "$PORT" -a -n "$PRE_PORT" ]; then
                    PORT="$PRE_PORT"
                    print_info "Using default settings with previously selected port: ${BLUE}$PORT${NC}"
                else
                    print_info "Using default settings."
                fi
                print_specs
                rm "$STATE_FILE"
                sleep 3
            fi
        else
            config_load $HELPER_NAME silent
        fi
        ;;
esac

get_latest_r() {
    local search=$1

    if [[ -z "$search" ]]; then
        echo "$AVAIL_R_VERSIONS" | xargs -n1 | tail -1
        return
    fi

    # Accept either exact version matches (e.g. 4.4.3) or prefix matches (e.g. 4.4 -> 4.4.x)
    local match=$(echo "$AVAIL_R_VERSIONS" | xargs -n1 | grep -E "^${search}($|\\.)" | tail -1)

    if [[ -n "$match" ]]; then
        echo "$match"
    else
        return 1
    fi
}
get_posit_docker_name() {
    local r_version=$1
    local arch=$(uname -m)
    case "$arch" in
        x86_64) arch="amd64" ;;
        aarch64) arch="arm64" ;;
        *) print_error "Unsupported architecture: $arch"; exit 1 ;;
    esac
    echo "docker://posit/r-base:${r_version}-${BASE_IMAGE_DISTRO}-${arch}"
}

# Track if -o flag is used to clear overlays on first use
_OVERLAYS_CLEARED=false
# Record original values for saving in state file (in case of -v option)
_NCPUS=$NCPUS
_MEM=$MEM
_TIME=$TIME
_GPU=$GPU

while getopts "r:c:m:t:g:p:e:o:v" opt; do
    case ${opt} in
        r ) R_VERSION=$OPTARG ;;
        c ) NCPUS=$OPTARG; _NCPUS=$OPTARG ;;
        m ) MEM=$OPTARG; _MEM=$OPTARG ;;
        t ) TIME=$OPTARG; _TIME=$OPTARG ;;
        g ) GPU=$OPTARG; _GPU=$OPTARG ;;
        v ) NCPUS=1; MEM=8G; TIME=02:00:00; echo "[MSG] View Mode: NCPUS=1, MEM=8G, TIME=02:00:00" ;;
        p ) PORT=$OPTARG ;;
        e ) OVERLAY=$OPTARG ;;
        o ) # First -o clears previous overlays, then builds fresh list
            if [ "$_OVERLAYS_CLEARED" = false ]; then OVERLAYS=""; _OVERLAYS_CLEARED=true; fi
            OVERLAYS="${OVERLAYS:+$OVERLAYS:}$OPTARG"
            ;;
        \? ) print_help; exit 1 ;;
    esac
done

# R Version check
if [ -z "$R_VERSION" ]; then
    R_VERSION=$(get_latest_r) || {
        print_error "Failed to get the latest R version."
        exit 1
    }
    print_warn "R version not specified. Use the latest available version: ${YELLOW}$R_VERSION${NC}"
    if ! confirm_default_yes "Proceed with this version?"; then
        echo "Aborted by user."; exit 1
    fi
else
    LATEST_MATCH=$(get_latest_r "$R_VERSION") || {
        print_error "Specified R version prefix '${YELLOW}$R_VERSION${NC}' is not available."
        exit 1
    }
    R_VERSION=$LATEST_MATCH
    print_info "Using specified R version: ${BLUE}$R_VERSION${NC}"
fi

# If no port specified, pick an available one
if [ -z "$PORT" ]; then
    PORT=$(choose_port) || {
        print_error "Failed to find an available port. Please specify one with -p."
        exit 1
    }
    print_info "Available port :${BLUE}$PORT${NC} auto-selected."
    print_info "Remember to set up port forwarding: ${CYAN}ssh -L $PORT:localhost:$PORT $USER@login-node${NC}"
    if ! confirm_default_yes "Proceed with this port?"; then
        echo "Aborted by user."; exit 1
    fi
else
    validate_port "$PORT"
fi

#region Sanity Checks
check_port_available "$PORT"
check_condatainer

if ! condatainer list -e r${R_VERSION} | grep -q "r${R_VERSION}"; then
    print_info "Installing R ${R_VERSION} overlay."
    condatainer create -n r${R_VERSION} -s $(get_posit_docker_name $R_VERSION)
    if [ $? -ne 0 ]; then
        print_error "Failed to install R version overlay 'r${R_VERSION}'."
        exit 1
    fi
fi

check_and_install_overlays rstudio-server build-essential $OVERLAYS

if [ ! -f "$OVERLAY" ]; then
    print_error "Overlay ${BLUE}$OVERLAY${NC} not found."
    exit 1
else
    check_overlay_integrity "$OVERLAY"
fi

setup_scratch
#endregion

# Construct arguments for CondaTainer exec
[ -n "$OVERLAY" ] && OVERLAY_ARG="-o $OVERLAY"
[ -n "$OVERLAYS" ] && OVERLAYS_ARG=$(build_overlays_arg "$OVERLAYS")
[ -n "$GPU" ] && GPU_SBATCH="#SBATCH --gres=gpu:$GPU"

CWD_FOLDER_NAME=$(basename $CWD)
RPROJECT_FILE="$CWD/$CWD_FOLDER_NAME.Rproj"
if ! [ -f "$RPROJECT_FILE" ]; then
    print_info "Creating RStudio project file at ${BLUE}$RPROJECT_FILE${NC}."
    cat <<EOT > $RPROJECT_FILE
Version: 1.0

RestoreWorkspace: Default
SaveWorkspace: Default
AlwaysSaveHistory: Default

EnableCodeIndexing: Yes
UseSpacesForTab: Yes
NumSpacesForTab: 2
Encoding: UTF-8

RnwWeave: Sweave
LaTeX: pdfLaTeX
EOT
    # If there is a bundled profile next to this script, copy it into the project
    # Prefer hidden .Rprofile in the helpers folder
    SRC=""
    if [ -f "$SCRIPT_DIR/.Rprofile" ]; then
        SRC="$SCRIPT_DIR/.Rprofile"
    fi
    if [ -n "$SRC" ]; then
        cp -f "$SRC" "$CWD/.Rprofile" && \
        print_info "Copied Rprofile to ${BLUE}$CWD/.Rprofile${NC} (overwritten if existed)."
    fi
fi
cat <<EOT > $HELPER_STATE_DIR/rsession.sh
#!/bin/bash

USER=`whoami`
source /etc/profile

# Source global definitions
if [ -f /etc/bashrc ]; then
  . /etc/bashrc
fi
source $HOME/.bashrc

export MAMBA_ROOT_PREFIX=/ext3/env
export CONDA_PREFIX=/ext3/env
export CONDA_DEFAULT_ENV=env
export CNT_CONDA_PREFIX=/ext3/env
export RETICULATE_PYTHON=/ext3/env/bin/python

/usr/lib/rstudio-server/bin/rsession "\$@"
EOT
chmod +x $HELPER_STATE_DIR/rsession.sh
cat <<EOT > $HELPER_STATE_DIR/rsession.conf
copilot-enabled=1
session-default-working-dir=$CWD
EOT
cat <<EOT > $HELPER_STATE_DIR/database.conf
provider=sqlite
directory=$SCRATCH/.local/lib/rstudio-server
EOT

SBATCH_SCRIPT_PATH="$LOG_DIR/$HELPER_NAME.sbatch"

cat <<EOT > $SBATCH_SCRIPT_PATH
#!/bin/bash
#SBATCH --job-name=$HELPER_NAME
#SBATCH --cpus-per-task=$NCPUS
#SBATCH --mem=$MEM
#SBATCH --time=$TIME
${GPU_SBATCH:+$GPU_SBATCH}
#SBATCH --output=$LOG_DIR/$HELPER_NAME-%j.log

# Remove the sbatch script after job submission
rm $SBATCH_SCRIPT_PATH

cat > $STATE_FILE <<RUNSTATE
JOB_ID=\$SLURM_JOB_ID
NODE=\$(hostname)
NCPUS=$_NCPUS
MEM=$_MEM
TIME=$_TIME
GPU=$_GPU
PORT=$PORT
CWD=$CWD
R_VERSION="$R_VERSION"
OVERLAY="$OVERLAY"
OVERLAYS="$OVERLAYS"
RUNSTATE

condatainer exec \\
    -o r${R_VERSION} \\
    -o rstudio-server \\
    -o build-essential \\
    $OVERLAYS_ARG \\
    $OVERLAY_ARG --writable \\
    /usr/lib/rstudio-server/bin/rserver \\
        --server-user $USER \\
        --server-daemonize=0 \\
        --server-data-dir=$SCRATCH/.local/run/rstudio-server \\
        --www-address=127.0.0.1 \\
        --www-port=$PORT \\
        --rsession-which-r=/usr/bin/R \\
        --rsession-path=$HELPER_STATE_DIR/rsession.sh \\
        --database-config-file=$HELPER_STATE_DIR/database.conf \\
        --rsession-config-file=$HELPER_STATE_DIR/rsession.conf \\
        --auth-none=1
EOT

SBATCH_OUTPUT=$(sbatch $SBATCH_SCRIPT_PATH)
SBATCH_JOB_ID=$(echo $SBATCH_OUTPUT | awk '{print $4}')

wait_for_job "$SBATCH_JOB_ID"
show_and_connect "$SBATCH_JOB_ID"
