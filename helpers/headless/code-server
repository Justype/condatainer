#!/bin/bash
# This script helps run code-server on current machine.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
source "$SCRIPT_DIR/.common.sh"
HELPER_NAME=code-server

# Save defaults on first run
config_init $HELPER_NAME \
    NCPUS=4 \
    MEM=16G \
    TIME=12:00:00 \
    GPU= \
    BASE_IMAGE= \
    BASE_IMAGE_DISTRO=noble \
    PORT= \
    AUTH=none \
    REUSE_MODE=ask \
    OVERLAY=env.img

# Load saved defaults
config_load $HELPER_NAME
config_require $HELPER_NAME OVERLAY AUTH

print_help() {
    echo "Usage: $0 [options]"
    echo ""
    echo "Options:"
    echo "  -p <port>       Port for $HELPER_NAME (default: ${PORT:-randomly picked}). Valid range: 1024-65535"
    echo "  -a <auth>       Password for $HELPER_NAME authentication (default: $AUTH)"
    echo ""
    echo "  -b <image>      Base image file"
    echo "  -e <.img>       Writable overlay (default: $OVERLAY)"
    echo "  -o <overlay>    Additional overlay files (can have multiple -o options)"
    echo ""
    echo "  config          Show config file path and contents"
    echo ""
    echo "State  file: $(state_path $HELPER_NAME)"
    echo "Config file: $(config_path $HELPER_NAME)"
}

case $1 in
    config)         config_show $HELPER_NAME ;;
    --help|-h|help) print_help; exit 0 ;;
    *)              ;;
esac

# Track if -o flag is used to clear overlays on first use
_OVERLAYS_CLEARED=false

while getopts "p:a:b:e:o:" opt; do
    case ${opt} in
        p ) PORT=$OPTARG ;;
        a ) AUTH=$OPTARG ;;
        b ) BASE_IMAGE="$OPTARG" ;;
        e ) OVERLAY=$OPTARG ;;
        o ) # First -o clears previous overlays, then builds fresh list
            if [ "$_OVERLAYS_CLEARED" = false ]; then OVERLAYS=""; _OVERLAYS_CLEARED=true; fi
            OVERLAYS="${OVERLAYS:+$OVERLAYS:}$OPTARG"
            ;;
        \? ) print_help; exit 1 ;;
    esac
done

# If no port specified, pick an available one
if [ -z "$PORT" ]; then
    PORT=$(choose_port) || {
        print_error "Failed to find an available port. Please specify one with -p."
        exit 1
    }
    print_info "Available port :${BLUE}$PORT${NC} auto-selected."
    print_info "Remember to set up port forwarding: ${CYAN}ssh -L $PORT:localhost:$PORT $USER@$HOSTNAME${NC}"
    if ! confirm_default_yes "Proceed with this port?"; then
        echo "Aborted by user."; exit 1
    fi
else
    validate_port "$PORT"
fi

#region Sanity Checks
check_port_available "$PORT"
check_condatainer

check_and_install_overlays code-server $OVERLAYS

if [ ! -f "$OVERLAY" ]; then
    print_warn "Overlay ${BLUE}$OVERLAY${NC} not found. Continuing without it."
    sleep 3
else
    check_overlay_integrity "$OVERLAY"
fi
#endregion

# Construct arguments for CondaTainer exec
[ -n "$BASE_IMAGE" ] && BASE_IMAGE_ARG="-b $BASE_IMAGE"
[ -n "$OVERLAY" ] && [ -f "$OVERLAY" ] && OVERLAY_ARG="-o $OVERLAY"
[ -n "$OVERLAYS" ] && OVERLAYS_ARG=$(build_overlays_arg "$OVERLAYS")
if [ "$AUTH" != "none" ]; then
    AUTH_OPTION="--auth password --password $AUTH"
else
    AUTH_OPTION="--auth none"
fi

print_info "Starting $HELPER_NAME at ${BLUE}http://localhost:$PORT?folder=$CWD${NC}"
if [ "$AUTH" != "none" ]; then
    print_info "  Password: ${YELLOW}$AUTH${NC}"
fi

condatainer exec \
    $BASE_IMAGE_ARG \
    -o code-server \
    $OVERLAYS_ARG \
    $OVERLAY_ARG --writable \
    code-server \
        --disable-update-check \
        --bind-addr 127.0.0.1:$PORT \
        $AUTH_OPTION
